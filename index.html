<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" />
<title>Daily Expenses Tracker ðŸŽ€</title>

<style>
    :root {
        --brand: #e91e63;
        --btn: #f8bbd0;
        --btn-hover: #f48fb1;
        --card-bg: rgba(255, 255, 255, 0.88);
        --border: #ccc;
        --text: #222;
        --table-header: #fafafa;
        --neg-text: #8b0000;
        --neg-bg: #ffe5e5;
    }

    body {
        margin: 0;
        font-family: 'Quicksand', sans-serif;
        color: var(--text);
        background: url('https://i.pinimg.com/736x/58/09/12/5809128d95aee17fdad43073ef5495be.jpg') no-repeat center center fixed;
        background-size: cover;
    }

    .app {
        max-width: 900px;
        margin: 40px auto 60px;
        background: var(--card-bg);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    h1 {
        text-align: center;
        color: var(--brand);
        margin: 6px 0 16px;
    }

    nav {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 18px;
    }

    nav button {
        background-color: var(--btn);
        border: none;
        padding: 10px 18px;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s ease;
    }

    nav button:hover {
        background-color: var(--btn-hover);
        transform: translateY(-1px);
    }

    .section { display: none; }
    .section.active { display: block; }

    .field { margin: 10px 0; }

    .field label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
    }

    input,
    select,
    textarea {
        width: 70%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-family: inherit;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th,
    td {
        padding: 10px;
        border: 1px solid var(--border);
        text-align: center;
        background: #fff;
    }

    th { background: var(--table-header); }
    ul { list-style: none; padding-left: 0; }
    .muted { color: #666; }
</style>
</head>

<body>
<div class="app">
    <h1>Daily Expenses Tracker ðŸŽ€</h1>

    <nav>
        <button onclick="switchTab('add')">âž• Add</button>
        <button onclick="switchTab('view')">ðŸ“Š View</button>
        <button onclick="switchTab('profit')">ðŸ’° Profit</button>
        <button onclick="switchTab('investment')">ðŸ“ˆ Investment</button>
    </nav>

    <!-- Add Section -->
    <div id="add" class="section active">
        <div class="field">
            <label>Date</label>
            <input type="date" id="date" />
        </div>
        <div class="field">
            <label>Amount</label>
            <input type="number" id="amount" placeholder="Enter amount" />
        </div>
        <div class="field">
            <label>Comments</label>
            <textarea id="note" placeholder="Enter comments"></textarea>
        </div>
        <button onclick="addTransaction()">Save Transaction</button>
    </div>

    <!-- View Section -->
    <div id="view" class="section">
        <div class="field">
            <label>Select Month</label>
            <select id="view-month" onchange="fetchView()"></select>
        </div>
        <table id="view-table"></table>
        <h3 id="total-expense">Total: â‚¹0</h3>
    </div>

    <!-- Profit Section -->
    <div id="profit" class="section">
        <div class="field">
            <label for="profit-month">Select Month</label>
            <select id="profit-month" onchange="fetchProfit()"></select>
        </div>
        <h3 id="profit-display">Profit: â‚¹0</h3>
    </div>

    <!-- Investment Section -->
    <div id="investment" class="section">
        <h3>Summary</h3>
        <ul id="investment-summary"></ul>

        <h3>Vendor Balances</h3>
        <table id="vendor-table"></table>

        <p class="muted">
            Color scale: negative = red, 0â€“4,999 = yellow gradient, â‰¥5,000 = green gradient.
        </p>
    </div>
</div>

<script>
const sheetURL = 'https://opensheet.elk.sh/1mlj8RGXIXwjR55LfRneMETz05ixuhl777LTzR7j2Urw/';
const summarySheetName = 'Vendor%20Sales%20Record';
const webAppURL = 'https://script.google.com/macros/s/AKfycbxFFMFjsUqTNsv6LOPCeMyK3554-995l8Jv_xTK2FEw8vim49HYFqyV47326uTwZe1Z/exec';
const sheetName = 'Transactions';
let transactions = [];

// Fetch all transactions
async function fetchExpenses() {
    const res = await fetch(`${webAppURL}?sheet=${sheetName}`);
    const data = await res.json();
    transactions = data
        .map(r => ({
            date: r.Date,
            amount: parseFloat(r.Amount),
            note: r.Note || r.Comments || ''
        }))
        .filter(t => t.date && !isNaN(t.amount));
    populateMonthDropdown();
}

// Populate month dropdown
function populateMonthDropdown() {
    const months = [...new Set(transactions.map(t => t.date.substring(0,7)))].sort();
    const sel = document.getElementById('view-month');
    sel.innerHTML = '';
    months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
    if(months.length) sel.value = months[months.length-1];
    fetchView();
}

// Add new transaction
async function addTransaction() {
    const date = document.getElementById('date').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const note = document.getElementById('note').value;

    if (!date || isNaN(amount)) {
        alert('Please enter valid date and amount');
        return;
    }

    const tx = { date, amount, note };
    await fetch(webAppURL, {
        method: 'POST',
        body: JSON.stringify({ sheet: sheetName, data: tx })
    });

    alert('Transaction saved!');
    document.getElementById('date').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('note').value = '';

    await fetchExpenses();
    switchTab('view');
}

// Show transactions for selected month
function fetchView() {
    const month = document.getElementById('view-month').value;
    const data = transactions.filter(t => t.date.startsWith(month));
    let total = 0;
    const table = document.getElementById('view-table');
    table.innerHTML = `<tr><th>Date</th><th>Amount</th><th>Comments</th></tr>`;
    data.forEach(t => {
        total += t.amount;
        table.innerHTML += `
            <tr>
                <td>${t.date}</td>
                <td>â‚¹${t.amount.toFixed(2)}</td>
                <td>${t.note}</td>
            </tr>`;
    });
    document.getElementById('total-expense').innerText = 'Total: â‚¹' + total.toFixed(2);
}

// =============== PROFIT TAB ==================
async function fetchProfit() {
    try {
        const res = await fetch(sheetURL + 'Profit%20Sheet');
        const data = await res.json();
        const months = [...new Set(data.map(r => r.Month).filter(Boolean))];
        const sel = document.getElementById('profit-month');
        sel.innerHTML = '';
        months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
        if (months.length) sel.value = months[months.length - 1];

        const month = sel.value;
        const row = data.find(r => r.Month === month);
        const val = parseFloat((row?.Profit || '0').replace(/[â‚¹,]/g, ''));
        document.getElementById('profit-display').innerText = 'Profit: â‚¹' + (isNaN(val) ? 0 : val).toFixed(2);
    } catch (e) {
        console.warn('Profit fetch failed', e);
    }
}

// =============== INVESTMENT TAB ==================
function yellowRamp(t){const a={r:255,g:249,b:196},b={r:255,g:193,b:7};return `rgb(${Math.round(a.r+(b.r-a.r)*t)},${Math.round(a.g+(b.g-a.g)*t)},${Math.round(a.b+(b.b-a.b)*t)})`; }
function greenRamp(t){const a={r:200,g:230,b:201},b={r:46,g:125,b:50};return `rgb(${Math.round(a.r+(b.r-a.r)*t)},${Math.round(a.g+(b.g-a.g)*t)},${Math.round(a.b+(b.b-a.b)*t)})`; }

async function fetchInvestment() {
    try {
        const resSummary = await fetch(sheetURL + summarySheetName);
        const summaryData = await resSummary.json();
        const summary = document.getElementById('investment-summary');
        summary.innerHTML = '';

        const SUMMARY_MAP = [
            { label: 'Available Wallet', rowIndex: 0, columnIndex: 9 },
            { label: 'Reseller Amount Due', rowIndex: 1, columnIndex: 9 },
            { label: 'Client Due', rowIndex: 2, columnIndex: 9 },
            { label: 'Total Amount Invested', rowIndex: 3, columnIndex: 9 }
        ];

        SUMMARY_MAP.forEach(item => {
            const row = summaryData[item.rowIndex] || {};
            const colKeys = Object.keys(row);
            const val = parseFloat(String(row[colKeys[item.columnIndex]] || '0').replace(/[â‚¹,]/g,''));
            summary.innerHTML += `<li>${item.label}: â‚¹${(isNaN(val)?0:val).toFixed(2)}</li>`;
        });

        const res = await fetch(sheetURL + 'Vendor%20Sales%20Record');
        const data = await res.json();
        const vendorTable = document.getElementById('vendor-table');
        vendorTable.innerHTML = '<tr><th>Vendor Name</th><th>Balance</th></tr>';

        const norm = s=>String(s).trim().toLowerCase();
        const sample = data.find(r=>Object.keys(r).map(norm).includes('vendor name'));
        const vendorKey = sample?Object.keys(sample).find(k=>norm(k)==='vendor name'):'Vendor Name';
        const balanceKey = sample?Object.keys(sample).find(k=>norm(k)==='balance'):'Balance';

        const rows = [];
        let maxPos=0;
        data.forEach(r=>{
            const name=r[vendorKey];
            const bal=parseFloat(String(r[balanceKey]||'0').replace(/[â‚¹,]/g,''));
            if(name && !isNaN(bal)){rows.push({name,bal});if(bal>0)maxPos=Math.max(maxPos,bal);}
        });

        rows.forEach(({name,bal})=>{
            let style='';
            if(bal<0)style='background:var(--neg-bg);color:var(--neg-text);font-weight:700;';
            else if(bal>0&&bal<5000)style='background:'+yellowRamp(Math.min(1,bal/5000))+';color:#222;';
            else if(bal>=5000)style='background:'+greenRamp(Math.min(1,(bal-5000)/Math.max(1,maxPos-5000)))+';color:#fff;';
            vendorTable.innerHTML+=`<tr><td>${name}</td><td style="${style}">â‚¹${bal.toFixed(2)}</td></tr>`;
        });
    } catch(e){ console.warn('Investment fetch failed', e); }
}

// =============== TAB HANDLER ==================
function switchTab(tab){
    document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    if(tab==='view') fetchView();
    if(tab==='profit') fetchProfit();
    if(tab==='investment') fetchInvestment();
}

// Initialize
fetchExpenses();
</script>
</body>
</html>
